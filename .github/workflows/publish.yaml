name: publish
on:
  workflow_dispatch:
  push:
    branches:
      - 'release-*'
      - 'master'
      - 'main'
    tags:
      - 'v*'
      - '!pkg*'
  workflow_run:
    workflows: ['Auto Tag']
    types:
      - completed

permissions:
  contents: write
  packages: write
  # id-token: write # Uncomment this line if you want to do cosign signing

jobs:
  publish:
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref_type == 'tag') || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    steps:
      - name: Checkout
        if: github.event_name == 'workflow_run'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Fetch tags
        if: github.event_name == 'workflow_run'
        run: git fetch --tags
      - name: Get tag from workflow_run
        if: github.event_name == 'workflow_run'
        id: get_tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$TAG" ]; then
            echo "No tag found"
            exit 1
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Found tag: $TAG"
      - name: Create release
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            TAG="${{ steps.get_tag.outputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          gh release create "$TAG" --title "Release $TAG" --generate-notes -R $GITHUB_REPOSITORY
        env:
          GH_TOKEN: ${{ github.token }}
  upload-assets:
    runs-on: ubuntu-latest
    needs: publish
    name: Upload release assets
    if: (github.event_name == 'push' && github.ref_type == 'tag') || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Fetch tags
        if: github.event_name == 'workflow_run'
        run: git fetch --tags
      - name: Get tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          else
            TAG="${{ github.ref_name }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG"
      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version: 1.25
          check-latest: true
      - name: Build Installer
        run: make build-installer IMG=ghcr.io/${{ github.repository_owner }}/valkey-operator:${{ steps.get_tag.outputs.tag }}
      - name: Attest
        uses: actions/attest-build-provenance@v3
        id: attest
        with:
          subject-path: |
            dist/install.yaml
      - name: Upload dist/install.yaml to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/install.yaml
          asset_name: install.yaml
          tag: ${{ steps.get_tag.outputs.tag }}
          overwrite: true
  publish-helm:
    runs-on: ubuntu-latest
    needs: publish
    name: Publish Helm Chart
    if: (github.event_name == 'push' && github.ref_type == 'tag') || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Fetch tags
        if: github.event_name == 'workflow_run'
        run: git fetch --tags
      - name: Get tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          else
            TAG="${{ github.ref_name }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG"
      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version: 1.25
          check-latest: true
      - name: Log in to the Container registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Authenticate Helm to OCI registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io \
            -u ${{ github.actor }} \
            --password-stdin
      - name: Package and Upload Helm Chart
        env:
          REGISTRY_OWNER: ${{ github.repository_owner }}
        run: make helm-publish V=1 IMG=ghcr.io/${{ github.repository_owner }}/valkey-operator:${{ steps.get_tag.outputs.tag }}
