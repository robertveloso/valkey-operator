name: publish
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version to publish (e.g., v1.0.3)'
        required: true
        type: string
  workflow_run:
    workflows: ['Create and publish a Docker image']
    types:
      - completed

permissions:
  contents: write
  packages: write
  # id-token: write # Uncomment this line if you want to do cosign signing

jobs:
  resolve-tag:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.name == 'Create and publish a Docker image')
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
    steps:
      - name: Download tag artifact from Auto Tag workflow
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: auto-tag.yaml
          workflow_conclusion: success
          name: release-tag
          path: ${{ runner.temp }}/tag
          commit: ${{ github.event.workflow_run.head_sha }}
      - name: Get tag from artifact
        if: github.event_name == 'workflow_run'
        id: get_tag_artifact
        run: |
          if [ -f "${{ runner.temp }}/tag/version.txt" ]; then
            TAG=$(cat ${{ runner.temp }}/tag/version.txt)
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "Using tag from artifact: $TAG"
          else
            echo "ERROR: Tag artifact not found. Cannot proceed without explicit tag."
            exit 1
          fi
      - name: Get tag from input (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: get_tag_input
        run: |
          TAG="${{ github.event.inputs.tag }}"
          if [ -z "$TAG" ]; then
            echo "ERROR: Tag input is required for workflow_dispatch"
            exit 1
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using tag from input: $TAG"
      - name: Set unified tag output
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "tag=${{ steps.get_tag_artifact.outputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ steps.get_tag_input.outputs.tag }}" >> $GITHUB_OUTPUT
          fi
  publish:
    needs: resolve-tag
    runs-on: ubuntu-latest
    concurrency:
      group: publish-${{ needs.resolve-tag.outputs.tag }}
      cancel-in-progress: false
    steps:
      - name: Checkout repository at workflow commit
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 0
      - name: Create release
        run: |
          gh release create "${{ needs.resolve-tag.outputs.tag }}" --title "Release ${{ needs.resolve-tag.outputs.tag }}" --generate-notes -R $GITHUB_REPOSITORY
        env:
          GH_TOKEN: ${{ github.token }}
  upload-assets:
    runs-on: ubuntu-latest
    needs: [resolve-tag, publish]
    name: Upload release assets
    concurrency:
      group: publish-assets-${{ needs.resolve-tag.outputs.tag }}
      cancel-in-progress: false
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write
    steps:
      - name: Checkout repository at workflow commit
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 0
      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version: 1.25
          check-latest: true
      - name: Build Installer
        run: make build-installer IMG=ghcr.io/${{ github.repository_owner }}/valkey-operator:${{ needs.resolve-tag.outputs.tag }}
      - name: Attest
        uses: actions/attest-build-provenance@v3
        id: attest
        with:
          subject-path: |
            dist/install.yaml
      - name: Upload dist/install.yaml to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/install.yaml
          asset_name: install.yaml
          tag: ${{ needs.resolve-tag.outputs.tag }}
          overwrite: true
  publish-helm:
    runs-on: ubuntu-latest
    needs: [resolve-tag, publish]
    name: Publish Helm Chart
    concurrency:
      group: publish-helm-${{ needs.resolve-tag.outputs.tag }}
      cancel-in-progress: false
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - name: Checkout repository at workflow commit
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 0
      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version: 1.25
          check-latest: true
      - name: Log in to the Container registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Authenticate Helm to OCI registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io \
            -u ${{ github.actor }} \
            --password-stdin
      - name: Package and Upload Helm Chart
        env:
          REGISTRY_OWNER: ${{ github.repository_owner }}
        run: make helm-publish V=1 IMG=ghcr.io/${{ github.repository_owner }}/valkey-operator:${{ needs.resolve-tag.outputs.tag }}
