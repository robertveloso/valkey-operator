name: Build Valkey Image

on:
  push:
    branches:
      - main
    paths:
      - 'Dockerfile.valkey'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force rebuild even if Dockerfile.valkey unchanged'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  VALKEY_VERSION: 9.0.1

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write

jobs:
  build-valkey:
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: self-hosted
    concurrency:
      group: valkey-${{ github.ref }}-${{ matrix.platform }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Prepare
        run: |
          platform=${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract metadata (Valkey)
        id: meta_valkey
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/valkey
          tags: ${{ env.VALKEY_VERSION }}
      - name: Build and push Valkey image
        id: docker_build_valkey
        uses: docker/build-push-action@v6
        with:
          file: Dockerfile.valkey
          context: .
          platforms: ${{ matrix.platform }}
          cache-from: type=gha
          # cache-to: type=gha,mode=max  # Commented out to avoid failures when GitHub Actions Cache is unavailable
          labels: ${{ steps.meta_valkey.outputs.labels }}
          tags: ${{ steps.meta_valkey.outputs.tags }}
          outputs: type=image,push=true
      - name: Get digest for attestation
        id: get_digest
        run: |
          # Obter digest do Valkey usando a tag (com retry para aguardar propagação)
          for i in {1..5}; do
            VALKEY_DIGEST=$(docker buildx imagetools inspect \
              ${{ env.REGISTRY }}/${{ github.repository_owner }}/valkey:${{ env.VALKEY_VERSION }} \
              --format '{{json .}}' 2>/dev/null | jq -r '.manifest.digest // .digest // empty' || echo "")
            if [ -n "$VALKEY_DIGEST" ] && [ "$VALKEY_DIGEST" != "null" ] && [ "$VALKEY_DIGEST" != "" ]; then
              break
            fi
            echo "Attempt $i/5: Waiting for Valkey image to be available..."
            sleep 2
          done
          if [ -z "$VALKEY_DIGEST" ] || [ "$VALKEY_DIGEST" = "null" ]; then
            echo "ERROR: Failed to get Valkey digest after retries"
            docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ github.repository_owner }}/valkey:${{ env.VALKEY_VERSION }} || true
            exit 1
          fi
          echo "Valkey digest: $VALKEY_DIGEST"
          echo "valkey_digest=$VALKEY_DIGEST" >> $GITHUB_OUTPUT
      # Note: Sign and Attest are done in merge-manifests job after manifest list is created
      - name: Export digest
        run: |
          mkdir -p ${{ runner.temp }}/digests/valkey
          VALKEY_DIGEST="${{ steps.get_digest.outputs.valkey_digest }}"
          touch "${{ runner.temp }}/digests/valkey/${VALKEY_DIGEST#sha256:}"
      - name: Upload digest
        uses: actions/upload-artifact@v6
        with:
          name: valkey-digests-${{ env.PLATFORM_PAIR }}
          path: ${{ runner.temp }}/digests/*
          retention-days: 1

  merge-manifests:
    runs-on: ubuntu-latest
    needs: build-valkey
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    outputs:
      valkey_manifest_digest: ${{ steps.get_manifest_digest.outputs.valkey_manifest_digest }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Download digests
        uses: actions/download-artifact@v7
        with:
          path: ${{ runner.temp }}/digests
          pattern: valkey-digests-*
          merge-multiple: true
      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Docker meta (Valkey)
        id: meta_valkey
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/valkey
          tags: ${{ env.VALKEY_VERSION }}
      - name: Create manifest list
        id: create_manifest_valkey
        working-directory: ${{ runner.temp }}/digests
        run: |
          cd valkey
          OUTPUT=$(docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ env.REGISTRY }}/${{ github.repository_owner }}/valkey@sha256:%s ' *) 2>&1)
          # Extract digest from output (format: "sha256:...")
          VALKEY_DIGEST=$(echo "$OUTPUT" | grep -oE 'sha256:[a-f0-9]{64}' | head -n1 || echo "")
          if [ -z "$VALKEY_DIGEST" ]; then
            echo "ERROR: Failed to extract Valkey manifest digest from output"
            echo "Output: $OUTPUT"
            exit 1
          fi
          echo "valkey_manifest_digest=$VALKEY_DIGEST" >> $GITHUB_OUTPUT
          echo "Valkey manifest digest: $VALKEY_DIGEST"
      - name: Get manifest list digest
        id: get_manifest_digest
        run: |
          # Use digest captured from imagetools create, with fallback to inspect if needed
          VALKEY_MANIFEST_DIGEST="${{ steps.create_manifest_valkey.outputs.valkey_manifest_digest }}"

          if [ -z "$VALKEY_MANIFEST_DIGEST" ] || [ "$VALKEY_MANIFEST_DIGEST" = "" ]; then
            echo "Warning: Valkey digest not captured from create, using inspect..."
            for i in {1..3}; do
              VALKEY_MANIFEST_DIGEST=$(docker buildx imagetools inspect \
                ${{ env.REGISTRY }}/${{ github.repository_owner }}/valkey:${{ env.VALKEY_VERSION }} \
                --format '{{json .}}' 2>/dev/null | jq -r '.manifest.digest // .digest // empty' || echo "")
              if [ -n "$VALKEY_MANIFEST_DIGEST" ] && [ "$VALKEY_MANIFEST_DIGEST" != "null" ]; then
                break
              fi
              sleep 1
            done
          fi

          if [ -z "$VALKEY_MANIFEST_DIGEST" ] || [ "$VALKEY_MANIFEST_DIGEST" = "null" ]; then
            echo "ERROR: Failed to get Valkey manifest list digest"
            exit 1
          fi

          echo "valkey_manifest_digest=$VALKEY_MANIFEST_DIGEST" >> $GITHUB_OUTPUT
          echo "Valkey manifest digest: $VALKEY_MANIFEST_DIGEST"
      - name: Set up Cosign
        uses: sigstore/cosign-installer@v3.7.0
      - name: Sign Valkey manifest list
        run: |
          cosign sign --yes ${{ env.REGISTRY }}/${{ github.repository_owner }}/valkey:${{ env.VALKEY_VERSION }}@${{ steps.get_manifest_digest.outputs.valkey_manifest_digest }}
      - name: Attest Valkey manifest list
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.REGISTRY }}/${{ github.repository_owner }}/valkey
          subject-digest: ${{ steps.get_manifest_digest.outputs.valkey_manifest_digest }}
          push-to-registry: true
      - name: Inspect image
        run: |
          docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ github.repository_owner }}/valkey:${{ env.VALKEY_VERSION }}
